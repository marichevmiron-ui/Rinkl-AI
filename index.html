<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content" />
    <title>Rinkl AI</title>
    
    <!-- Favicon / Site Icon (SVG Base64) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgcng9IjEyOCIgZmlsbD0iIzFhNzNlOCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0iY2VudHJhbCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtd2VpZ2h0PSJib2xkIiBmb250LXNpemU9IjI1NiIgZmlsbD0id2hpdGUiPlI8L3RleHQ+PC9zdmc+" />
    
    <meta name="theme-color" content="#1a73e8">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#1a73e8',
              'primary-dark': '#0d62d9',
              'chat-user': '#2c3e50',
              'chat-ai': '#f1f3f4',
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              mono: ['JetBrains Mono', 'monospace'],
            },
            animation: {
                'fade-in': 'fadeIn 0.3s ease-out forwards',
                'slide-up': 'slideUp 0.4s ease-out forwards',
            },
            keyframes: {
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                },
                slideUp: {
                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                }
            }
          }
        }
      }
    </script>
    <style>
      html, body {
        height: 100%;
        overflow: hidden;
        overscroll-behavior: none;
        -webkit-tap-highlight-color: transparent;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .dark ::-webkit-scrollbar-thumb { background: #475569; }
      .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      
      .typing-dots span { animation: typing 1.4s infinite; opacity: 0.6; }
      .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
      .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
      @keyframes typing { 0%, 60%, 100% { opacity: 0.6; } 30% { opacity: 1; } }

      .glass {
          background: rgba(255, 255, 255, 0.85);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
      }
      .dark .glass {
          background: rgba(31, 41, 55, 0.85);
      }
    </style>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3"
  }
}
</script>
</head>
<body class="bg-[#f8fafc] dark:bg-gray-900 text-gray-900 dark:text-gray-100 overflow-hidden fixed inset-0 font-sans selection:bg-blue-200 dark:selection:bg-blue-900">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
        import { GoogleGenAI } from "@google/genai";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, update, push, set, query, orderByChild, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const { useState, useEffect, useRef, useMemo, memo } = React;
        
        const API_KEYS = [
            "AIzaSyA_tf9A72GxzpcC7v1lXWFQGqkVFWBN820",
            "AIzaSyDk0tuyVpWEdqZ0-EUJXNntMK3YOGA1g8g",
            "AIzaSyAU-BK_uOte2K72RUhVW-dKTtCpaXUxVRM",
            "AIzaSyBPD3KLbmXe1HzbOJtmC4iqxpJhncRUE-Y"
        ];

        const PROXY_URLS = [
            "https://corsproxy.io/?",
            "https://api.allorigins.win/raw?url=",
        ];

        const SUPPORTED_LANGUAGES = {
            en: 'English',
            ru: 'Русский',
            es: 'Español',
            cn: 'Chinese',
            de: 'Deutsch'
        };

        const TRANSLATIONS = {
            ru: {
                newChat: 'Новый чат',
                settings: 'Настройки',
                chat: 'Чат',
                newConversation: 'Новый разговор',
                typeMessage: 'Введите сообщение...',
                editMessage: 'Редактировать сообщение',
                cancel: 'Отмена',
                saveRegenerate: 'Сохранить и перегенерировать',
                dataManagement: 'Управление данными',
                usedStorage: 'Использовано памяти',
                clearCache: 'Очистить кэш',
                language: 'Язык',
                appearance: 'Оформление',
                feedback: 'Обратная связь',
                confirmClear: 'Вы уверены, что хотите удалить все сохраненные данные? Это действие нельзя отменить.',
                deleteChat: 'Удалить этот чат?',
                errorNetwork: 'Ошибка подключения',
                errorReadMore: 'Подробнее',
                regionErrorTitle: 'Временная недоступность сервиса Rinkl AI в вашем регионе',
                regionErrorText: 'К сожалению, в настоящее время доступ к Rinkl AI ограничен с территории следующих государств:\n\nАфганистан, Андорра, Беларусь, Ватикан, Иран, Куба, КНДР (Северная Корея), Лихтенштейн, Монако, Россия, Сан-Марино, Сирия.\n\nПриносим извинения за доставленные неудобства. Мы работаем над расширением географии доступности сервиса.',
                close: 'Закрыть',
                noResponse: 'Нет ответа.',
                copy: 'Копировать',
                edit: 'Изменить',
                light: 'Светлая',
                dark: 'Темная',
                auto: 'Авто',
                feedbackBtn: 'Обратная связь',
                feedbackTitle: 'Обратная связь',
                messageType: 'Тип сообщения',
                yourMessage: 'Ваше сообщение',
                sendMessage: 'Отправить',
                sending: 'Отправка...',
                myMessages: 'Мои сообщения',
                adminResponse: 'Ответ администратора',
                waitingResponse: 'Ожидание ответа...',
                selectType: 'Выберите тип',
                typeFeedback: 'Отзыв',
                typeBug: 'Баг',
                typeQuestion: 'Вопрос',
                typeSuggestion: 'Предложение',
                typeOther: 'Другое',
                msgSent: 'Спасибо! Ваше сообщение отправлено.',
                fillFields: 'Пожалуйста, заполните все поля',
                noReviews: 'Пока нет сообщений. Отправьте первое!',
                slogan1: 'ИИ, который мыслит иначе',
                slogan2: 'Думай меньше. Делай больше.',
                slogan3: 'Где идеи становятся реальностью',
                start: 'Начать'
            },
            en: {
                newChat: 'New Chat',
                settings: 'Settings',
                chat: 'Chat',
                newConversation: 'New Conversation',
                typeMessage: 'Type a message...',
                editMessage: 'Edit Message',
                cancel: 'Cancel',
                saveRegenerate: 'Save & Regenerate',
                dataManagement: 'Data Management',
                usedStorage: 'Used Storage',
                clearCache: 'Clear Cache',
                language: 'Language',
                appearance: 'Appearance',
                feedback: 'Feedback',
                confirmClear: 'Are you sure you want to delete all saved data? This cannot be undone.',
                deleteChat: 'Delete this chat?',
                errorNetwork: 'Connection error',
                errorReadMore: 'Read more',
                regionErrorTitle: 'Rinkl AI Service Temporarily Unavailable in Your Region',
                regionErrorText: 'Unfortunately, access to Rinkl AI is currently restricted from territories like Russia, Liechtenstein, and others. Please use a VPN or proxy if you are in these areas.',
                close: 'Close',
                noResponse: 'No response.',
                copy: 'Copy',
                edit: 'Edit',
                light: 'Light',
                dark: 'Dark',
                auto: 'Auto',
                feedbackBtn: 'Feedback',
                feedbackTitle: 'Feedback & Support',
                messageType: 'Type of message',
                yourMessage: 'Your message',
                sendMessage: 'Send Message',
                sending: 'Sending...',
                myMessages: 'My Messages',
                adminResponse: 'Admin Response',
                waitingResponse: 'Waiting for admin response...',
                selectType: 'Select type',
                typeFeedback: 'Feedback',
                typeBug: 'Bug Report',
                typeQuestion: 'Question',
                typeSuggestion: 'Suggestion',
                typeOther: 'Other',
                msgSent: 'Thank you! Your message has been sent.',
                fillFields: 'Please fill all fields',
                noReviews: 'No messages yet. Send your first message!',
                slogan1: 'AI that thinks differently',
                slogan2: 'Think less. Do more.',
                slogan3: 'Where ideas become reality',
                start: 'Start'
            }
        };

        const getTranslation = (lang, key) => {
            return TRANSLATIONS[lang]?.[key] || TRANSLATIONS['en'][key] || key;
        };

        // --- COMPONENTS ---

        const WelcomeScreen = memo(({ onStart, settings, onUpdateSettings }) => {
            const [sloganIndex, setSloganIndex] = useState(0);
            const [opacity, setOpacity] = useState(0);
            const [isLangMenuOpen, setIsLangMenuOpen] = useState(false);
            
            const slogans = ['slogan1', 'slogan2', 'slogan3'];
            const t = (key) => getTranslation(settings.language, key);

            useEffect(() => {
                let mounted = true;
                const cycle = async () => {
                    while (mounted) {
                        setOpacity(1);
                        await new Promise(r => setTimeout(r, 2800));
                        if (!mounted) break;
                        setOpacity(0);
                        await new Promise(r => setTimeout(r, 800));
                        if (!mounted) break;
                        setSloganIndex(prev => (prev + 1) % slogans.length);
                    }
                };
                cycle();
                return () => { mounted = false; };
            }, []);

            return (
                <div className="fixed inset-0 z-50 flex flex-col h-full w-full bg-white dark:bg-gray-900 overflow-hidden transition-colors duration-300">
                    <div className="h-1/2 w-full bg-gradient-to-br from-[#5C9CE5] to-[#4A8BE0] flex flex-col items-center justify-center relative px-6 text-center shadow-lg">
                        <div className="text-6xl md:text-7xl font-bold text-black mb-8 select-none tracking-tight">
                            Rinkl AI
                        </div>
                        <div 
                            className="text-2xl md:text-3xl text-white font-medium transition-opacity duration-[800ms] ease-in-out absolute bottom-20 w-full px-8"
                            style={{ opacity: opacity }}
                        >
                            {t(slogans[sloganIndex])}
                        </div>
                    </div>
                    <div className="h-1/2 w-full bg-white dark:bg-gray-900 flex flex-col items-center pt-16 px-10 relative transition-colors duration-300">
                        <button 
                            onClick={onStart}
                            className="w-full max-w-md h-14 bg-[#4A8BE0] rounded-2xl text-white font-bold text-xl shadow-lg hover:bg-[#3d7bc9] hover:shadow-xl active:scale-95 transition-all duration-200"
                        >
                            {t('start')}
                        </button>
                        <div className="mt-8 relative">
                            <button onClick={() => setIsLangMenuOpen(!isLangMenuOpen)} className="flex items-center gap-2 text-gray-500 dark:text-gray-400">
                                <span className="underline underline-offset-4 text-sm font-medium">{SUPPORTED_LANGUAGES[settings.language]}</span>
                            </button>
                            {isLangMenuOpen && (
                                <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-100 dark:border-gray-700 py-2 z-10 overflow-hidden">
                                    {Object.keys(SUPPORTED_LANGUAGES).map(lang => (
                                        <button key={lang} onClick={() => { onUpdateSettings({ language: lang }); setIsLangMenuOpen(false); }} className={`w-full text-left px-4 py-2.5 text-sm ${settings.language === lang ? 'text-[#4A8BE0] font-bold bg-blue-50 dark:bg-blue-900/20' : 'text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50'}`}>
                                            {SUPPORTED_LANGUAGES[lang]}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        });

        const CodeBlock = memo(({ text }) => {
            const [copied, setCopied] = useState(false);
            const content = text.replace(/^```[a-zA-Z0-9]*\n?/, '').replace(/```$/, '');
            let lang = 'code';
            const match = text.match(/^```([a-zA-Z0-9]+)/);
            if (match) lang = match[1];

            const handleCopy = () => {
                navigator.clipboard.writeText(content);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            return (
                <div className="my-3 rounded-lg overflow-hidden bg-[#1e1e1e] border border-gray-700/50 shadow-lg group">
                    <div className="flex items-center justify-between px-4 py-2 bg-[#252526] border-b border-gray-700/50">
                        <span className="text-xs text-gray-500 font-mono lowercase">{lang}</span>
                        <button onClick={handleCopy} className="text-xs text-gray-400 hover:text-white transition-colors bg-gray-700/50 px-2 py-1 rounded">
                            {copied ? 'Copied' : 'Copy'}
                        </button>
                    </div>
                    <div className="p-4 overflow-x-auto custom-scrollbar">
                        <code className="text-[13px] leading-relaxed font-mono text-gray-300 whitespace-pre">{content}</code>
                    </div>
                </div>
            );
        });

        const SettingsModal = memo(({ isOpen, onClose, settings, onUpdateSettings, onClearData, onOpenFeedback }) => {
            const [storageSize, setStorageSize] = useState('0 KB');
            const t = (key) => getTranslation(settings.language, key);

            useEffect(() => {
                if (isOpen) {
                    let total = 0;
                    for (const key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) total += (localStorage[key].length + key.length) * 2;
                    }
                    setStorageSize((total / 1024).toFixed(2) + ' KB');
                }
            }, [isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[2000] flex items-center justify-center p-4 animate-fade-in font-sans">
                    <div className="bg-white dark:bg-gray-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col animate-slide-up">
                        <div className="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                            <h2 className="text-lg font-bold dark:text-white">{t('settings')}</h2>
                            <button onClick={onClose} className="p-1 rounded-full text-gray-400 hover:text-gray-700">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div className="p-6 space-y-8">
                            <section>
                                <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">{t('dataManagement')}</h3>
                                <div className="bg-gray-50 dark:bg-gray-700/30 rounded-xl p-4 flex justify-between items-center mb-4">
                                    <span className="text-sm font-medium dark:text-gray-300">{t('usedStorage')}</span>
                                    <span className="font-mono text-sm dark:text-white font-bold">{storageSize}</span>
                                </div>
                                <button onClick={() => { if(window.confirm(t('confirmClear'))) onClearData(); }} className="w-full bg-red-500 hover:bg-red-600 text-white py-2.5 rounded-lg text-sm font-semibold">
                                    {t('clearCache')}
                                </button>
                            </section>
                            <section>
                                <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">{t('language')}</h3>
                                <div className="grid grid-cols-2 gap-2">
                                    {Object.keys(SUPPORTED_LANGUAGES).map((lang) => (
                                        <button key={lang} onClick={() => onUpdateSettings({ language: lang })} className={`py-2 px-3 rounded-lg text-sm transition-all ${settings.language === lang ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 dark:bg-gray-700/50 dark:text-gray-400'}`}>
                                            {SUPPORTED_LANGUAGES[lang]}
                                        </button>
                                    ))}
                                </div>
                            </section>
                            <section>
                                <h3 className="text-xs font-bold text-gray-400 uppercase mb-3">{t('appearance')}</h3>
                                <div className="flex bg-gray-100 dark:bg-gray-700/50 p-1.5 rounded-xl">
                                    {['light', 'dark', 'auto'].map((mode) => (
                                        <button key={mode} onClick={() => onUpdateSettings({ theme: mode })} className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${settings.theme === mode ? 'bg-white text-gray-900 shadow-sm dark:bg-gray-600 dark:text-white' : 'text-gray-500 dark:text-gray-400'}`}>
                                            {t(mode)}
                                        </button>
                                    ))}
                                </div>
                            </section>
                        </div>
                        <div className="p-4 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-100 dark:border-gray-800 text-center">
                            <p className="text-[10px] text-gray-400 font-mono">Rinkl AI v1.0.41</p>
                        </div>
                    </div>
                </div>
            );
        });

        const ChatScreen = memo(({ settings, onUpdateSettings, onNavigateFeedback }) => {
            const [chats, setChats] = useState({});
            const [currentChatId, setCurrentChatId] = useState('default');
            const [inputText, setInputText] = useState('');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isTyping, setIsTyping] = useState(false);
            const [mediaList, setMediaList] = useState([]);
            const [connectionStatus, setConnectionStatus] = useState('connected');
            const [activeProxyUrl, setActiveProxyUrl] = useState(null);
            const [showRegionError, setShowRegionError] = useState(false);
            
            const messagesEndRef = useRef(null);
            const chatContainerRef = useRef(null);
            const textareaRef = useRef(null);
            const fileInputRef = useRef(null);
            const t = (key) => getTranslation(settings.language, key);

            useEffect(() => {
                const saved = localStorage.getItem('rinkl_ai_chats');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setChats(parsed);
                        if (!parsed['default'] && Object.keys(parsed).length === 0) setChats({ 'default': [] });
                    } catch (e) { setChats({ 'default': [] }); }
                } else { setChats({ 'default': [] }); }
            }, []);

            useEffect(() => {
                if (Object.keys(chats).length > 0) localStorage.setItem('rinkl_ai_chats', JSON.stringify(chats));
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chats, currentChatId, isTyping]);

            const fetchViaProxy = async (proxyUrl, history, config, apiKey) => {
                const modelName = 'gemini-3-flash-preview';
                const baseUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                const targetUrl = proxyUrl + encodeURIComponent(baseUrl);
                
                const restContents = history.map(item => ({
                    role: item.role,
                    parts: item.parts.map(p => {
                        if (p.inlineData) return { inline_data: { mime_type: p.inlineData.mimeType, data: p.inlineData.data } };
                        return p;
                    })
                }));

                const response = await fetch(targetUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: restContents,
                        system_instruction: { parts: [{ text: "You are Rinkl AI. Developed by Rinkl." }] },
                        generationConfig: { temperature: config.temperature, maxOutputTokens: config.maxOutputTokens }
                    })
                });

                if (!response.ok) throw new Error("Proxy error");
                const data = await response.json();
                return { text: data.candidates[0].content.parts[0].text };
            };

            const generateContent = async (history) => {
                const config = { temperature: 0.7, maxOutputTokens: 1000 };
                
                if (activeProxyUrl) {
                    for (const key of API_KEYS) {
                        try { return await fetchViaProxy(activeProxyUrl, history, config, key); } catch(e) {}
                    }
                    setActiveProxyUrl(null);
                }

                try {
                    for (const apiKey of API_KEYS) {
                        try {
                            const ai = new GoogleGenAI({ apiKey });
                            const response = await ai.models.generateContent({
                                model: 'gemini-3-flash-preview',
                                contents: history,
                                config: { systemInstruction: "You are Rinkl AI. Developed by Rinkl." }
                            });
                            setConnectionStatus('connected');
                            return { text: response.text };
                        } catch (e) { if (API_KEYS.indexOf(apiKey) === API_KEYS.length - 1) throw e; }
                    }
                } catch (e) {
                    setConnectionStatus('connecting');
                    for (const proxy of PROXY_URLS) {
                        for (const key of API_KEYS) {
                            try {
                                const res = await fetchViaProxy(proxy, history, config, key);
                                setActiveProxyUrl(proxy);
                                setConnectionStatus('connected');
                                return res;
                            } catch (err) {}
                        }
                    }
                }
                setConnectionStatus('disconnected');
                throw new Error("Failed all attempts");
            };

            const handleSendMessage = async () => {
                if ((!inputText.trim() && mediaList.length === 0) || isTyping) return;
                const newMessage = { id: Date.now().toString(), text: inputText.trim(), sender: 'user', media: [...mediaList] };
                const updatedChats = { ...chats };
                if (!updatedChats[currentChatId]) updatedChats[currentChatId] = [];
                updatedChats[currentChatId].push(newMessage);
                setChats(updatedChats);
                setInputText('');
                setMediaList([]);
                setIsTyping(true);

                try {
                    const history = updatedChats[currentChatId].map(msg => ({
                        role: msg.sender === 'user' ? 'user' : 'model',
                        parts: msg.media?.length ? [{ text: msg.text }, ...msg.media.map(m => ({ inlineData: { mimeType: m.type, data: m.data.split(',')[1] } }))] : [{ text: msg.text }]
                    }));
                    const response = await generateContent(history);
                    setChats(prev => ({ ...prev, [currentChatId]: [...prev[currentChatId], { id: Date.now().toString(), text: response.text, sender: 'ai' }] }));
                } catch (e) {
                    setChats(prev => ({ ...prev, [currentChatId]: [...prev[currentChatId], { id: Date.now().toString(), text: t('errorNetwork'), sender: 'ai', isError: true }] }));
                } finally { setIsTyping(false); }
            };

            const renderContent = (msg) => {
                if (msg.isError) return (
                    <div className="text-red-500 font-bold">{t('errorNetwork')} <button onClick={() => setShowRegionError(true)} className="text-blue-500 underline ml-2">{t('errorReadMore')}</button></div>
                );
                const parts = msg.text.split(/(```[\s\S]*?```|`[^`]+`|\*\*[^*]+\*\*)/g);
                return parts.map((part, i) => {
                    if (part.startsWith('```')) return <CodeBlock key={i} text={part} />;
                    if (part.startsWith('`')) return <code key={i} className="bg-gray-100 dark:bg-gray-800 text-pink-500 px-1.5 py-0.5 rounded font-mono border dark:border-gray-700">{part.replace(/`/g, '')}</code>;
                    if (part.startsWith('**')) return <strong key={i} className="font-bold text-gray-900 dark:text-gray-100">{part.replace(/\*\*/g, '')}</strong>;
                    return <span key={i} className="whitespace-pre-wrap">{part}</span>;
                });
            };

            return (
                <div className="flex h-full flex-col bg-[#f8fafc] dark:bg-gray-900 font-sans transition-all">
                    <header className="flex-none flex items-center justify-center p-4 bg-white/80 dark:bg-gray-800/80 backdrop-blur-md shadow-sm border-b dark:border-gray-800 z-20">
                        <button onClick={() => setIsSidebarOpen(true)} className="absolute left-4 p-2 text-gray-600 dark:text-gray-300">
                            <div className="w-5 h-0.5 bg-current mb-1"></div><div className="w-5 h-0.5 bg-current mb-1"></div><div className="w-5 h-0.5 bg-current"></div>
                        </button>
                        <div className={`px-4 py-1.5 rounded-full border border-opacity-30 font-semibold text-sm flex items-center gap-2 ${connectionStatus === 'connected' ? 'bg-green-50 text-green-700 dark:bg-green-900/20' : 'bg-red-50 text-red-600'}`}>Rinkl AI</div>
                    </header>
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/30 backdrop-blur-sm z-30" onClick={() => setIsSidebarOpen(false)} />}
                    <aside className={`fixed top-0 left-0 h-full w-[280px] bg-white/95 dark:bg-gray-800/95 backdrop-blur-md shadow-2xl z-40 transform transition-transform duration-300 flex flex-col ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-5 border-b dark:border-gray-700 space-y-3">
                            <button onClick={() => { setChats(p => ({ ...p, ['chat_'+Date.now()]: [] })); setIsSidebarOpen(false); }} className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold">{t('newChat')}</button>
                            <button onClick={() => setIsSettingsOpen(true)} className="w-full py-3 bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-white rounded-xl font-medium">{t('settings')}</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-3 space-y-2">
                            {Object.keys(chats).map(id => (
                                <div key={id} onClick={() => { setCurrentChatId(id); setIsSidebarOpen(false); }} className={`p-3.5 rounded-xl cursor-pointer border ${currentChatId === id ? 'bg-blue-50 border-blue-100 dark:bg-blue-900/20' : 'border-transparent hover:bg-gray-50 dark:hover:bg-gray-700'}`}>
                                    <div className="font-semibold text-sm dark:text-gray-200">{t('chat')} {id.split('_')[1]?.slice(-4) || '1'}</div>
                                    <div className="text-xs text-gray-500 truncate mt-1">{chats[id][chats[id].length-1]?.text || t('newConversation')}</div>
                                </div>
                            ))}
                        </div>
                    </aside>
                    <main className="flex-1 flex flex-col relative max-w-4xl mx-auto w-full h-full min-h-0 overflow-hidden">
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 space-y-8 min-h-0 scroll-smooth custom-scrollbar">
                            {chats[currentChatId]?.map((msg, idx) => (
                                <div key={idx} className={`flex flex-col max-w-[90%] animate-slide-up ${msg.sender === 'user' ? 'ml-auto items-end' : 'mr-auto items-start'}`}>
                                    <div className={`px-5 py-3.5 shadow-sm text-[15px] leading-7 mb-1.5 transition-all ${msg.sender === 'user' ? 'bg-[#2c3e50] text-white rounded-[20px] rounded-br-[4px]' : 'bg-white text-gray-800 dark:bg-gray-800 dark:text-gray-100 rounded-[20px] rounded-bl-[4px] border dark:border-gray-700'}`}>
                                        {msg.media?.map((m, i) => <img key={i} src={m.url} className="w-24 h-24 object-cover rounded-xl mb-2" />)}
                                        {renderContent(msg)}
                                    </div>
                                    <button onClick={() => navigator.clipboard.writeText(msg.text)} className="p-1.5 text-gray-400 hover:text-blue-500"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                                </div>
                            ))}
                            {isTyping && (
                                <div className="flex items-start"><div className="bg-white dark:bg-gray-800 p-4 rounded-[20px] border dark:border-gray-700"><div className="typing-dots flex space-x-1.5"><span className="w-1.5 h-1.5 bg-gray-400 rounded-full"></span><span className="w-1.5 h-1.5 bg-gray-400 rounded-full"></span><span className="w-1.5 h-1.5 bg-gray-400 rounded-full"></span></div></div></div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="p-4 flex-none z-20">
                            <div className="flex items-end bg-white dark:bg-gray-800 rounded-[26px] shadow-lg border dark:border-gray-700 p-2">
                                <textarea value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); handleSendMessage();} }} placeholder={t('typeMessage')} className="flex-1 py-2.5 px-3 bg-transparent border-none outline-none resize-none text-gray-800 dark:text-gray-100 text-[15px]" rows={1} />
                                <button onClick={handleSendMessage} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${!inputText.trim() ? 'bg-gray-100 dark:bg-gray-700 text-gray-400' : 'bg-blue-600 text-white'}`}><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z"/></svg></button>
                            </div>
                        </div>
                    </main>
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} settings={settings} onUpdateSettings={onUpdateSettings} onClearData={() => { localStorage.clear(); window.location.reload(); }} />
                    {showRegionError && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[3000] flex items-center justify-center p-4"><div className="bg-white dark:bg-gray-800 w-full max-w-2xl rounded-2xl p-8"><h2 className="text-xl font-bold mb-4">{t('regionErrorTitle')}</h2><p className="text-gray-600 dark:text-gray-300 mb-6">{t('regionErrorText')}</p><button onClick={() => setShowRegionError(false)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">{t('close')}</button></div></div>
                    )}
                </div>
            );
        });

        const App = () => {
            const [isLoading, setIsLoading] = useState(true);
            const [settings, setSettings] = useState({ theme: 'auto', language: 'en' });
            const [showOnboarding, setShowOnboarding] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('rinkl_settings');
                const done = localStorage.getItem('rinkl_onboarding_completed');
                if (saved) try { setSettings(JSON.parse(saved)); } catch(e) {}
                if (!done) setShowOnboarding(true);
                setIsLoading(false);
            }, []);

            useEffect(() => {
                const isDark = settings.theme === 'dark' || (settings.theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                document.documentElement.classList.toggle('dark', isDark);
            }, [settings.theme]);

            if (isLoading) return null;
            if (showOnboarding) return <WelcomeScreen onStart={() => { localStorage.setItem('rinkl_onboarding_completed', 'true'); setShowOnboarding(false); }} settings={settings} onUpdateSettings={s => { const upd = {...settings,...s}; setSettings(upd); localStorage.setItem('rinkl_settings',JSON.stringify(upd)); }} />;
            return <ChatScreen settings={settings} onUpdateSettings={s => { const upd = {...settings,...s}; setSettings(upd); localStorage.setItem('rinkl_settings',JSON.stringify(upd)); }} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>